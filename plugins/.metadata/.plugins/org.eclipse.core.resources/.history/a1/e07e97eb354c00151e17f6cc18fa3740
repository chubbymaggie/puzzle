package fr.inria.diverse.puzzle.metrics.chartMetrics;

import java.util.ArrayList;
import java.util.List;

import org.eclipse.emf.ecore.EClassifier;

import fr.inria.diverse.k3.sle.common.comparisonOperators.ConceptComparison;
import fr.inria.diverse.k3.sle.common.comparisonOperators.MethodComparison;
import fr.inria.diverse.melange.metamodel.melange.Language;
import fr.inria.diverse.puzzle.metrics.auxiliarMetrics.CollectConstructs;
import fr.inria.diverse.puzzle.metrics.auxiliarMetrics.CountConstructs;
import fr.inria.diverse.puzzle.metrics.auxiliarMetrics.CountConstructsOccurrences;

/**
 * Chart metric for the family's maintenance costs versus product line maintenance costs.
 * @author David Mendez-Acuna
 */
public class MaintananceCosts implements ChartMetric {

	// ---------------------------------------------------
	// Methods
	// ---------------------------------------------------
	
	@Override
	public String getVariablesDeclaration(ArrayList<Language> languages,
			ConceptComparison conceptComparisonOperator,
			MethodComparison methodComparisonOperator) throws Exception {
		
		int[] constructsAmountsArray = this.getConstructsAmount(languages, conceptComparisonOperator);
		double pendiente = this.getAverageCostSyntax(languages, conceptComparisonOperator, methodComparisonOperator);
		int manHoursByConstruct = 2;
		
		String javaScriptData = "google.load('visualization', '1.1', {packages: ['line', 'corechart']});\n";
		javaScriptData += "google.setOnLoadCallback(drawChart);\n\n";
		javaScriptData += "    function drawChart() {\n";
		javaScriptData += "      var classicChart;\n";
		javaScriptData += "      var classicDiv = document.getElementById('chart-maitenance-costs-syntax');\n";
		javaScriptData += "      var data = new google.visualization.DataTable()\n";
		javaScriptData += "      data.addColumn('number', \"AmountOfConstructs\");\n";
		javaScriptData += "      data.addColumn('number', \"FamilyApproach\");\n";
		javaScriptData += "      data.addColumn('number', \"Product line approach\");\n\n";
		javaScriptData += "      data.addRows([\n";
		
		for (int i = 0; i < constructsAmountsArray.length; i++) {
			javaScriptData += "        [" + constructsAmountsArray[i] + ",  " + constructsAmountsArray[i] * manHoursByConstruct + ",  " + constructsAmountsArray[i] * manHoursByConstruct * pendiente + "],\n";
		}
		
		javaScriptData += "      ]);\n\n";
		javaScriptData += "      var classicOptions = {\n";
		javaScriptData += "        title: 'Maintenance costs of the family of DSLs vs. maintenance costs of its corresponding language product line (abstract syntax)',\n";
		javaScriptData += "        titleTextStyle: {fontSize: 10, fontName: \"lucida sans unicode\" },\n";
		javaScriptData += "        width: 650,\n";
		javaScriptData += "        height: 280,\n";
		javaScriptData += "        series: {\n";
		javaScriptData += "          0: {targetAxisIndex: 0}\n";
		javaScriptData += "        },\n";
		javaScriptData += "        vAxes: {\n";
		javaScriptData += "          0: {title: 'Maintenance Costs (Man-Hour)',\n";
		javaScriptData += "              titleTextStyle: {fontSize: 10, fontName: \"lucida sans unicode\" },\n";
		javaScriptData += "              textStyle: {fontSize: 10, fontName: \"lucida sans unicode\", bold: true }\n";
		javaScriptData += "             }\n";
		javaScriptData += "        },\n";
		javaScriptData += "        hAxis: {\n";
		javaScriptData += "          title: 'Amount of Involved Constructs',\n";
		javaScriptData += "          titleTextStyle: {fontSize: 10, fontName: \"lucida sans unicode\" },\n";
		javaScriptData += "          textStyle: {fontSize: 10, fontName: \"lucida sans unicode\", bold: true },\n";
		javaScriptData += "          ticks: [";
		
		boolean first = true;
		for (int i = 0; i < constructsAmountsArray.length; i++) {
			if(!first) javaScriptData += ", ";
			javaScriptData += constructsAmountsArray[i];
			first = false;
		}
		javaScriptData += "]\n";
		javaScriptData += "        },\n";
		javaScriptData += "        legend: { position: 'top',\n";
		javaScriptData += "      			  textStyle: {fontSize: 10, fontName: \"lucida sans unicode\" }\n";
		javaScriptData += "    			}\n";
		javaScriptData += "      	};\n";
		javaScriptData += "      classicChart = new google.visualization.LineChart(classicDiv);\n";
		javaScriptData += "      classicChart.draw(data, classicOptions);\n";
		javaScriptData += "    }\n";
		
		return javaScriptData;
	}

	@Override
	public String getWindow(ArrayList<Language> languages) {
		String javaScriptWindow = "    var ctxLineChartSyntaxMaintaince = document.getElementById(\"chart-maintainance-costs-syntax\").getContext(\"2d\");\n";
		javaScriptWindow += "    window.myLineChartSyntaxMaintaince = new Chart(ctxLineChartSyntaxMaintaince).Line(barsDataSyntaxMaintainanceCosts,{\n";
		javaScriptWindow += "       datasetFill : false\n";
		javaScriptWindow += "    });\n\n";
		
		javaScriptWindow += "    var chart = new google.visualization.LineChart(document.getElementById('chart-maintainance-costs-semantics'));}";
		javaScriptWindow += "    chart.draw(barsDataSemanticMaintainanceCosts, options);\n";
		
//		javaScriptWindow += "    var ctxLineChartSemanticsMaintaince = document.getElementById(\"chart-maintainance-costs-semantics\").getContext(\"2d\");\n";
//		javaScriptWindow += "    window.myLineChartSemanticsMaintaince = new Chart(ctxLineChartSemanticsMaintaince).Line(barsDataSemanticMaintainanceCosts,{\n";
//		javaScriptWindow += "       datasetFill : false\n";
//		javaScriptWindow += "    });\n\n";
		return javaScriptWindow;
	}
	
	// ---------------------------------------------------
	// Auxiliar services
	// ---------------------------------------------------
	
	private int[] getConstructsAmount(ArrayList<Language> languages, ConceptComparison conceptComparisonOperator) throws Exception {
		int[] answer = new int[7];
		int constructsAmount = CountConstructs.countFamilyConstructs(languages, conceptComparisonOperator);
		int interval = constructsAmount/6;
		for (int i = 0; i < 7; i++) {
			answer[i] += interval * (i);
		}
		return answer;
	}
	
	public double getAverageCostSyntax(ArrayList<Language> languages,
			ConceptComparison conceptComparisonOperator,
			MethodComparison methodComparisonOperator) throws Exception{
		double totalCost = 0;
		List<EClassifier> constructs = CollectConstructs.collectFamilyConstructs(languages, conceptComparisonOperator);
		for (EClassifier eClassifier : constructs) {
			totalCost += CountConstructsOccurrences.intCountConstructOccurrences(languages, conceptComparisonOperator, eClassifier);
		}
		if(constructs.size() == 0)
			return 0;
		else
			return totalCost/constructs.size();
	}
}