package fr.inria.diverse.k3.sle.common.tuples;

import java.util.ArrayList;

import org.eclipse.emf.ecore.EAttribute;
import org.eclipse.emf.ecore.EClass;
import org.eclipse.emf.ecore.EClassifier;
import org.eclipse.emf.ecore.EEnum;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.EStructuralFeature;

public class EcoreGraph {

	// -----------------------------------------------
	// Attributes
	// -----------------------------------------------
	
	private ArrayList<EcoreNode> nodes;
	private ArrayList<EcoreArc> arcs;
	
	// -----------------------------------------------
	// Constructor
	// -----------------------------------------------
	
	/**
	 * Constructor by default. Returns an emtpy graph. 
	 */
	public EcoreGraph(){
		this.nodes = new ArrayList<EcoreNode>();
		this.arcs = new ArrayList<EcoreArc>();
	}
	
	/**
	 * Constructor that builds a dependencies graph from a list of Concept-Members tuple
	 */
	public EcoreGraph(ArrayList<TupleConceptMembers> conceptMembersList){
		this.nodes = new ArrayList<EcoreNode>();
		this.arcs = new ArrayList<EcoreArc>();
	}
	
	// -----------------------------------------------
	// Getters
	// -----------------------------------------------

	public ArrayList<EcoreNode> getNodes() {
		return nodes;
	}

	public ArrayList<EcoreArc> getArcs() {
		return arcs;
	}
	
	// -----------------------------------------------
	// Methods
	// -----------------------------------------------
	
	/**
	 * Computes the dependencies graph from a list of tuples Concept-Members
	 * @param conceptMembersList
	 * @return
	 */
	public EcoreGraph computeDependenciesGraph(ArrayList<TupleConceptMembers> conceptMembersList){
		EcoreGraph graph = new EcoreGraph();
		for (TupleConceptMembers conceptMembersGroupVO : conceptMembersList) {
			EClassifier currentClassifier = conceptMembersGroupVO.getConcept();
			EcoreNode node = new EcoreNode(currentClassifier.getName(), currentClassifier);
			graph.getNodes().add(node);
		}
		
		// Adding one arc for each reference
		for (EcoreNode node : graph.getNodes()) {
			EClassifier currentClassifier = node.getClassifier();
			
			if(currentClassifier instanceof EClass){
				EClass currentEClass = (EClass) currentClassifier;
				for (EStructuralFeature structuralFeature : currentEClass.getEStructuralFeatures()) {
					if(structuralFeature instanceof EReference){
						EReference currentEReference = (EReference) structuralFeature;
						EcoreNode toNode = getNodeByName(graph, currentEReference.getEType().getName());
						if(toNode != null){
							EcoreArc arc = new EcoreArc(node, toNode);
							graph.getArcs().add(arc);
						}
					}
					
					if(structuralFeature instanceof EAttribute){
						EAttribute currentEAttribute = (EAttribute) structuralFeature;
						if(currentEAttribute.getEType() instanceof EEnum){
							EcoreNode toNode = getNodeByName(graph, currentEAttribute.getEType().getName());
							if(toNode != null){
								EcoreArc arc = new EcoreArc(node, toNode);
								graph.getArcs().add(arc);
							}
						}
					}
				}
			}
		}
		
		// Adding one arc for each inheritance
		for (EcoreNode node : graph.getNodes()) {
			EClassifier currentClassifier = node.getClassifier();
			
			if(currentClassifier instanceof EClass){
				EClass currentEClass = (EClass) currentClassifier;
				for (EClass superClass : currentEClass.getESuperTypes()) {
					EcoreNode toNode = getNodeByName(graph, superClass.getName());
					if(toNode != null){
						EcoreArc arc = new EcoreArc(node, toNode);
						graph.getArcs().add(arc);
					}
				}
			}
		}
		return graph;
	}
	
	private EcoreNode getNodeByName(EcoreGraph graph, String nodeName){
		for (EcoreNode node : graph.getNodes()) {
			if(node.getClassifier().getName().equals(nodeName))
				return node;
		} return null;
	}
}